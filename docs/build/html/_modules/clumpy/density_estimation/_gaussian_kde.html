
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>clumpy.density_estimation._gaussian_kde &#8212; clumpy 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">clumpy 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">clumpy.density_estimation._gaussian_kde</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for clumpy.density_estimation._gaussian_kde</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Jul 20 20:16:24 2021</span>

<span class="sd">@author: frem</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bandwidth_selection</span>
<span class="kn">from</span> <span class="nn">._density_estimator</span> <span class="kn">import</span> <span class="n">DensityEstimator</span>
<span class="kn">from</span> <span class="nn">._whitening_transformer</span> <span class="kn">import</span> <span class="n">_WhiteningTransformer</span>
<span class="kn">from</span> <span class="nn">..utils._hyperplane</span> <span class="kn">import</span> <span class="n">Hyperplane</span>
<span class="kn">from</span> <span class="nn">..tools._console</span> <span class="kn">import</span> <span class="n">title_heading</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">restart_line</span><span class="p">():</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_compute_gaussian_kde</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">support_factor</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">neighbors_id</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">radius_neighbors</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">h</span> <span class="o">*</span> <span class="n">support_factor</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">verbose</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">restart_line</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_steps</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_gaussian</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">]))</span>

<div class="viewcode-block" id="GKDE"><a class="viewcode-back" href="../../../generated/clumpy.density_estimation.GKDE.html#clumpy.density_estimation.GKDE">[docs]</a><span class="k">class</span> <span class="nc">GKDE</span><span class="p">(</span><span class="n">DensityEstimator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gaussian Kernel Density Estimator. It is a child of sklearn.BaseEstimator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h : float or {&#39;scott&#39;, &#39;silverman&#39;}, default=&#39;scott&#39;</span>
<span class="sd">         The bandwidth. It can be a float or a method :</span>
<span class="sd">             scott : The scott&#39;s rule :math:`h=-1 / n^{d+4}`.</span>
<span class="sd">             </span>
<span class="sd">             silverman : The Silverman&#39;s rule which is the same as Scott&#39;s rule.</span>
<span class="sd">             </span>
<span class="sd">    low_bounded_features : list of int, default=[]</span>
<span class="sd">        The low bounded features indices.</span>
<span class="sd">    </span>
<span class="sd">    high_bounded_features : list of int, default=[]</span>
<span class="sd">        The high bounded features indices.</span>
<span class="sd">    </span>
<span class="sd">    low_bounds : list of float, default=[]</span>
<span class="sd">        Consequently to ``low_bounded_features`` value, the low bounds are</span>
<span class="sd">        specified here.</span>
<span class="sd">    </span>
<span class="sd">    high_bounds : list of float, =[]</span>
<span class="sd">        Consequently to ``high_bounded_features`` value, the high bounds are</span>
<span class="sd">        specified here.</span>
<span class="sd">        </span>
<span class="sd">    preprocessing : None or {&#39;whitening&#39;}, default=&#39;whitening&#39;</span>
<span class="sd">        Preprocessing transformation.</span>
<span class="sd">        </span>
<span class="sd">            whitening : Whitening transformation to get a covariance matrix equal to the identity matrix.</span>
<span class="sd">    </span>
<span class="sd">    algorithm : {&#39;auto&#39;, &#39;ball_tree&#39;, &#39;kd_tree&#39;, &#39;brute&#39;}, default=``&#39;auto&#39;``</span>
<span class="sd">        Algorithm used to compute the nearest neighbors as sklearn.</span>
<span class="sd">        </span>
<span class="sd">            &#39;ball_tree&#39; will use BallTree</span>
<span class="sd">            </span>
<span class="sd">            &#39;kd_tree&#39; will use KDTree</span>
<span class="sd">            </span>
<span class="sd">            &#39;brute&#39; will use a brute-force search.</span>
<span class="sd">            </span>
<span class="sd">            &#39;auto&#39; will attempt to decide the most appropriate algorithm based on the values passed to fit method.</span>
<span class="sd">        </span>
<span class="sd">        Note: fitting on sparse input will override the setting of this parameter, using brute force.</span>
<span class="sd">        </span>
<span class="sd">    leaf_size : int, default=30</span>
<span class="sd">        Leaf size passed to BallTree or KDTree. This can affect the speed of the construction and query, as well as the memory required to store the tree. The optimal value depends on the nature of the problem.</span>

<span class="sd">    support_factor : float, default=3</span>
<span class="sd">        The kernel support factor, even if kernel has infinite support.</span>

<span class="sd">    n_fit_max : int, default=np.inf</span>
<span class="sd">        The maximum number of training samples. A random sampling is done if necessary.</span>

<span class="sd">    n_predict_max : int, default=2*10**4</span>
<span class="sd">        The maximum of simultaneous probability estimations.</span>
<span class="sd">        Several streams are consequently created.</span>

<span class="sd">    forbid_null_value : bool, default=False</span>
<span class="sd">        If ``True``, the null value is forbiden and a correction is made if</span>
<span class="sd">        necessary.</span>

<span class="sd">    n_jobs_predict : int, default=2</span>
<span class="sd">        The number of parallel jobs to predict according to streams defined</span>
<span class="sd">        by ``n_predict_max``.</span>

<span class="sd">    n_jobs_neighbors : int, default=1</span>
<span class="sd">        The number of parallel jobs to run for neighbors search.</span>

<span class="sd">    verbose : int, default=0</span>
<span class="sd">        The verbosity level.</span>

<span class="sd">    verbose_heading_level : int, default=1</span>
<span class="sd">        Verbose heading level for markdown titles. If ``0``, no markdown title are printed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">h</span><span class="o">=</span><span class="s1">&#39;scott&#39;</span><span class="p">,</span>
                 <span class="n">low_bounded_features</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">high_bounded_features</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">low_bounds</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">high_bounds</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">preprocessing</span><span class="o">=</span><span class="s1">&#39;whitening&#39;</span><span class="p">,</span>
                 <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;kd_tree&#39;</span><span class="p">,</span>
                 <span class="n">leaf_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">support_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">n_fit_max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">n_predict_max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">forbid_null_value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">n_jobs_predict</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">n_jobs_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">verbose_heading_level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">low_bounded_features</span><span class="o">=</span><span class="n">low_bounded_features</span><span class="p">,</span>
                         <span class="n">high_bounded_features</span><span class="o">=</span><span class="n">high_bounded_features</span><span class="p">,</span>
                         <span class="n">low_bounds</span> <span class="o">=</span> <span class="n">low_bounds</span><span class="p">,</span>
                         <span class="n">high_bounds</span> <span class="o">=</span> <span class="n">high_bounds</span><span class="p">,</span>
                         <span class="n">forbid_null_value</span> <span class="o">=</span> <span class="n">forbid_null_value</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                         <span class="n">verbose_heading_level</span><span class="o">=</span><span class="n">verbose_heading_level</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaf_size</span> <span class="o">=</span> <span class="n">leaf_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span> <span class="o">=</span> <span class="n">support_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fit_max</span> <span class="o">=</span> <span class="n">n_fit_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_predict_max</span> <span class="o">=</span> <span class="n">n_predict_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs_predict</span> <span class="o">=</span> <span class="n">n_jobs_predict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs_neighbors</span> <span class="o">=</span> <span class="n">n_jobs_neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">=</span> <span class="n">preprocessing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="s1">&#39;GKDE(h=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="s1">&#39;GKDE(h=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

    
<div class="viewcode-block" id="GKDE.fit"><a class="viewcode-back" href="../../../generated/clumpy.density_estimation.GKDE.html#clumpy.density_estimation.GKDE.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit according to observations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_features)</span>
<span class="sd">            The observations.</span>
<span class="sd">        </span>
<span class="sd">        y : None</span>
<span class="sd">            Not used. It is provided for compatibility only.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self: GKDE</span>
<span class="sd">            The fitted GKDE object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title_heading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_heading_level</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;GKDE fitting...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fit_max</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_fit_max</span><span class="p">,</span>
                                   <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_force_forbid_null_value</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n_fit_max overshoot. Random sampling done.&#39;</span><span class="p">)</span>

        <span class="c1"># preprocessing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">==</span> <span class="s1">&#39;whitening&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span> <span class="o">=</span> <span class="n">_WhiteningTransformer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">X</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preprocessing done.&#39;</span><span class="p">)</span>
        
        <span class="c1"># get data dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># BOUNDARIES INFORMATIONS</span>
        <span class="c1"># low bounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_bounds</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unexpected low bounds value&quot;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_low_bounds_hyperplanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">id_k</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">))</span>
            <span class="n">A</span><span class="p">[:,</span><span class="n">id_k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounds</span><span class="p">[</span><span class="n">id_k</span><span class="p">]</span>
            
            <span class="n">A_wt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_low_bounds_hyperplanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hyperplane</span><span class="p">()</span><span class="o">.</span><span class="n">set_by_points</span><span class="p">(</span><span class="n">A_wt</span><span class="p">))</span>

        <span class="c1"># high bounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_bounds</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unexpected low bounds value&quot;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_high_bounds_hyperplanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">id_k</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">))</span>
            <span class="n">A</span><span class="p">[:,</span><span class="n">id_k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounds</span><span class="p">[</span><span class="n">id_k</span><span class="p">]</span>
            
            <span class="n">A_wt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_high_bounds_hyperplanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hyperplane</span><span class="p">()</span><span class="o">.</span><span class="n">set_by_points</span><span class="p">(</span><span class="n">A_wt</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Boundaries initialization done.&#39;</span><span class="p">)</span>

        <span class="c1"># BANDWIDTH SELECTION</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="s1">&#39;scott&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="s1">&#39;silverman&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">=</span> <span class="n">bandwidth_selection</span><span class="o">.</span><span class="n">scotts_rule</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected bandwidth selection method.&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unexpected bandwidth type.&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bandwidth selection done : h=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h</span><span class="p">))</span>
        
        <span class="c1"># NORMALIZATION FACTOR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalization</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span>
        
        <span class="c1"># NEAREST NEIGHBOR FITTING</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title_heading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_heading_level</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;sklearn.neighbors.NearestNeighbors fitting...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span><span class="p">,</span>
                                   <span class="n">algorithm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">,</span>
                                   <span class="n">leaf_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaf_size</span><span class="p">,</span>
                                   <span class="n">n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs_neighbors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sklearn.neighbors.NearestNeighbors fitting done.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GKDE fitting done.&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="GKDE.predict"><a class="viewcode-back" href="../../../generated/clumpy.density_estimation.GKDE.html#clumpy.density_estimation.GKDE.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the requested probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_features)</span>
<span class="sd">            The samples to estimate the probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : ndarray of shape (n_samples,)</span>
<span class="sd">            The estimated probabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title_heading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_heading_level</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;GKDE Predict&#39;</span><span class="p">)</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_with_bandwidth</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GKDE predict done.&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">_predict_with_bandwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method.</span>
<span class="sd">        Predict with a specified bandwidth</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_features)</span>
<span class="sd">            The samples to estimate the probability.</span>
<span class="sd">        h : float</span>
<span class="sd">            The bandwidth.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : ndarray of shape (n_samples,)</span>
<span class="sd">            The estimated probabilities.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get indices outside bounds</span>
        <span class="c1"># it will be use to cut off the result later</span>
        <span class="n">id_out_of_low_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounds</span><span class="p">)</span>
        <span class="n">id_out_of_high_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounds</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        

        <span class="c1"># STEPS INITIALIZATION</span>
        <span class="c1"># requested elements are not estimated alltogether in order to</span>
        <span class="c1"># improve numerical computations.</span>
        <span class="c1"># the limit is given by n_predict_max</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_predict_max</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title_heading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_heading_level</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Gaussian kernel&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;process with &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; streams computed in parallel through &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs_predict</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; CPUs.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs_predict</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
            
            <span class="c1"># for each set of n_predict_max elements</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">n_predict_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">_compute_gaussian_kde</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nn</span><span class="p">,</span>
                                                                  <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">n_predict_max</span><span class="p">],</span>
                                                                  <span class="n">h</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span><span class="p">)</span>
                    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs_predict</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">_compute_gaussian_kde</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nn</span><span class="p">,</span> 
                                                      <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">n_predict_max</span><span class="p">],</span>
                                                      <span class="n">h</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span><span class="p">,</span>
                                                      <span class="n">id_i</span><span class="p">,</span>
                                                      <span class="n">steps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_i</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">)])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">restart_line</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;done</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gaussian kernel process done.&#39;</span><span class="p">)</span>

        <span class="c1"># Normalization</span>
        <span class="n">f</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalization</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span>
        
        <span class="c1"># boundary bias correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title_heading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_heading_level</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Boundary bias correction...&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bounds_hyperplanes</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_low_bounds_hyperplanes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high_bounds_hyperplanes</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">hyperplane</span> <span class="ow">in</span> <span class="n">bounds_hyperplanes</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">erf</span><span class="p">(</span><span class="n">hyperplane</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            
        <span class="c1"># outside bounds : equal to 0</span>
        <span class="n">f</span><span class="p">[</span><span class="n">id_out_of_low_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f</span><span class="p">[</span><span class="n">id_out_of_high_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Boundary bias correction done.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Preprocessing correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">scale_</span><span class="p">)</span>

            <span class="c1"># if null value is forbiden</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forbid_null_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_forbid_null_value</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">title_heading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_heading_level</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Null value correction...&#39;</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">f</span> <span class="o">==</span> <span class="mf">0.0</span>

                <span class="n">new_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">+</span> <span class="n">idx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">/</span> <span class="n">new_n</span>

                <span class="n">min_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">new_n</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalization</span> <span class="o">*</span> <span class="n">_gaussian</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">f</span><span class="p">[</span><span class="n">f</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_value</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Null value correction done.&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
<div class="viewcode-block" id="GKDE.marginal"><a class="viewcode-back" href="../../../generated/clumpy.density_estimation.GKDE.html#clumpy.density_estimation.GKDE.marginal">[docs]</a>    <span class="k">def</span> <span class="nf">marginal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">x</span><span class="p">,</span>
                 <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the marginal probability.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like of shape (n_samples,)</span>
<span class="sd">            The samples to estimate along the `$k$` feature.</span>
<span class="sd">        k : int</span>
<span class="sd">            The feature index.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : ndarray of shape (n_samples,)</span>
<span class="sd">            The estimated marginal probabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
        
        <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span><span class="p">,</span>
                              <span class="n">algorithm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">,</span>
                              <span class="n">leaf_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_size</span><span class="p">,</span>
                              <span class="n">n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:,[</span><span class="n">k</span><span class="p">]])</span>
        
        <span class="n">distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">radius_neighbors</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span>
                                           <span class="n">radius</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span><span class="p">,</span>
                                           <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_gaussian</span><span class="p">(</span><span class="n">dist</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span><span class="p">)</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="p">:</span>
            <span class="n">id_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">erf</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low_bounds</span><span class="p">[</span><span class="n">id_k</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            
            <span class="n">f</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low_bounds</span><span class="p">[</span><span class="n">id_k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="p">:</span>
            <span class="n">id_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">erf</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_high_bounds</span><span class="p">[</span><span class="n">id_k</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            
            <span class="n">f</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high_bounds</span><span class="p">[</span><span class="n">id_k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">scale_</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        
        <span class="k">return</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="GKDE.cut_plot"><a class="viewcode-back" href="../../../generated/clumpy.density_estimation.GKDE.html#clumpy.density_estimation.GKDE.cut_plot">[docs]</a>    <span class="k">def</span> <span class="nf">cut_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">n_eval</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">label_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the value along a cut.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either x or q are expected.&quot;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one undefined features is expected. Example: x=[0.2, None, 0.1, 0.6]&quot;</span><span class="p">))</span>
            
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            
            <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">k_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">k</span><span class="p">)</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            
            
            
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one undefined features is expected. Example: x=[0.2, None, 0.1, 0.6]&quot;</span><span class="p">))</span>
            
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            
            <span class="n">k</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">k_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)),</span> <span class="n">k</span><span class="p">)</span>
            
            <span class="n">q</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">qi</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            
            
        
        <span class="c1"># print(k_bar)</span>
        <span class="n">X_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_eval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">))</span>
        <span class="n">X_eval</span><span class="p">[:,</span> <span class="n">k_bar</span><span class="p">]</span> <span class="o">*=</span> <span class="n">x</span><span class="p">[</span><span class="n">k_bar</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low_bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">low_bounded_features</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span>
        
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high_bounds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">high_bounded_features</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span>
        
        <span class="n">X_eval</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_eval</span><span class="p">)</span>
       
        <span class="n">X_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">X_eval</span><span class="p">)</span>
       
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_eval</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_eval</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">pred</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="n">label_prefix</span><span class="o">+</span><span class="n">label</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">)</span>
        
        <span class="k">return</span><span class="p">(</span><span class="n">X_eval</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">plt</span><span class="p">)</span></div></div>
    


</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">clumpy 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">clumpy.density_estimation._gaussian_kde</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, François-Rémi Mazy.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.2.
    </div>
  </body>
</html>